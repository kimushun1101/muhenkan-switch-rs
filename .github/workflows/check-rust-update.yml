name: Check Rust update

on:
  schedule:
    # 毎月1日 9:00 JST (0:00 UTC)
    - cron: '0 0 1 * *'
  workflow_dispatch:

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Get current Rust version from mise.toml
        id: current
        run: |
          version=$(grep -m1 '^rust' mise.toml | sed 's/.*"\(.*\)".*/\1/')
          echo "version=$version" >> "$GITHUB_OUTPUT"
          echo "Current: $version"

      - name: Get latest stable Rust version
        id: latest
        run: |
          # major.minor のみ取得 (パッチは無視)
          full=$(curl -sSf https://static.rust-lang.org/dist/channel-rust-stable.toml | grep -m1 '^version' | sed 's/version = "\(.*\)"/\1/')
          version=$(echo "$full" | cut -d. -f1,2)
          echo "version=$version" >> "$GITHUB_OUTPUT"
          echo "full=$full" >> "$GITHUB_OUTPUT"
          echo "Latest: $version (full: $full)"

      - name: Create issue if update available
        if: steps.current.outputs.version != steps.latest.outputs.version
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          CURRENT="${{ steps.current.outputs.version }}"
          LATEST="${{ steps.latest.outputs.version }}"
          FULL="${{ steps.latest.outputs.full }}"

          existing=$(gh issue list --state open --search "Rust $LATEST" --json number --jq 'length')
          if [ "$existing" -gt 0 ]; then
            echo "Issue already exists for Rust $LATEST, skipping."
            exit 0
          fi

          {
            echo "## Rust アップデート検知"
            echo ""
            echo "| | バージョン |"
            echo "|---|---|"
            echo "| 現在 | \`$CURRENT\` |"
            echo "| 最新 | \`$LATEST\` ($FULL) |"
            echo ""
            echo "### リリースノート"
            echo "https://blog.rust-lang.org/"
            echo ""
            echo "### 対応手順"
            echo "1. リリースノートで破壊的変更がないか確認"
            echo "2. \`mise.toml\` の \`rust\` バージョンを \`\"$LATEST\"\` に更新"
            echo "3. ビルド・動作確認"
          } > /tmp/issue-body.md

          gh issue create \
            --title "Rust $LATEST がリリースされました" \
            --body-file /tmp/issue-body.md
          echo "Issue created for Rust $LATEST"
