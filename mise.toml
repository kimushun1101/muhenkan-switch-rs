# mise.toml — 開発環境 & タスク定義
# 使い方:
#   mise install         Rust ツールチェーンのセットアップ
#   mise run build       debug ビルド → ルートにコピー
#   mise run release     release ビルド → ルートにコピー
#   mise run dev         ビルド後、kanata も起動
#   mise run gui         ビルド後、GUI を起動

[tools]
rust = "1.93"

[tasks.build]
description = "Build workspace (debug)"
shell = "bash -c"
run = """
cargo build --workspace
EXT=""; [ "$OS" = "Windows_NT" ] && EXT=".exe"
cp "target/debug/muhenkan-switch${EXT}" "./muhenkan-switch${EXT}"
echo "[dev] Copied -> ./muhenkan-switch${EXT}"
if [ -f "target/debug/muhenkan-switch-gui${EXT}" ]; then
  cp "target/debug/muhenkan-switch-gui${EXT}" "./muhenkan-switch-gui${EXT}"
  echo "[dev] Copied -> ./muhenkan-switch-gui${EXT}"
fi
"""

[tasks.release]
description = "Build workspace (release)"
shell = "bash -c"
run = """
cargo build --workspace --release
EXT=""; [ "$OS" = "Windows_NT" ] && EXT=".exe"
cp "target/release/muhenkan-switch${EXT}" "./muhenkan-switch${EXT}"
echo "[dev] Copied -> ./muhenkan-switch${EXT}"
if [ -f "target/release/muhenkan-switch-gui${EXT}" ]; then
  cp "target/release/muhenkan-switch-gui${EXT}" "./muhenkan-switch-gui${EXT}"
  echo "[dev] Copied -> ./muhenkan-switch-gui${EXT}"
fi
"""

[tasks.dev]
description = "Build and start kanata"
depends = ["build"]
shell = "bash -c"
run = """
EXT=""; [ "$OS" = "Windows_NT" ] && EXT=".exe"
KANATA="./kanata_cmd_allowed${EXT}"
KBD="./kanata/muhenkan.kbd"
if [ ! -f "$KANATA" ]; then
  echo "[dev] kanata_cmd_allowed が見つかりません。"
  echo "[dev] インストールスクリプトを実行するか、手動で配置してください。"
  exit 1
fi
echo "[dev] Starting kanata..."
echo "[dev] Ctrl+C で終了"
"$KANATA" --cfg "$KBD"
"""

[tasks.gui]
description = "Build and start GUI"
shell = "bash -c"
run = """
echo "[dev] Starting GUI..."
cargo run -p muhenkan-switch-gui
"""
